"use strict";var proxymity=function(e){function n(e){return Array.prototype.slice.call(e||[])}function t(e,t){return n(e).forEach(t)}function r(e){return"function"==typeof e}function o(e){return"string"==typeof e}function i(e){return"boolean"==typeof e}function a(e){return"number"==typeof e&&!isNaN(e)}function u(e){return"object"==typeof e}function c(e){return Object.getOwnPropertyNames(e)}function f(e,n){var t,r,o;return void 0===n||e>n?(r=e,t=n||0):(t=e,r=n),o=r-t,Math.round(Math.random()*(o+.9998)-.4999)+t}var s="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_";function l(e=16){for(var n=s[f(51)],t=1;t<e;t++)n+=s[f(62)];return n}function v(e,n){var r=c(n);for(var o in e)n[o]=e[o],r.splice(r.indexOf(o),1);t(r,function(e,t){e||"length"===t||delete n[t]}.bind(null,Array.isArray(n)))}var p=function(){var e=l(f(32,48)),n=!1,r=[];return window.addEventListener("message",function(o){if(o.data===e){o.stopPropagation();var i=r;e=l(f(32,48)),n=!1,r=[],t(i,function(e){e()})}}),function(t){n||(window.postMessage(e,"*"),n=!0),r.push(t)}}();var h={objectify:function(){if(Array.isArray(this))var e=[];else e={};var n=c(this);for(var t in n){var r=n[t];u(this[r])&&this[r].objectify?e[r]=this[r].objectify():e[r]=this[r]}return e},stringify:function(){var e=n(arguments);return e.unshift(h.objectify.call(this)),JSON.stringify.apply(JSON,e)},toString:function(){return c(this).length?h.stringify.call(this):""},watch:function(n,t){var r=this;return k(r[b](),function(){return e.call(r,"this"+("["===n[0]?"":".")+n)},function(e){e&&t(e.value)})},[Symbol.toPrimitive]:function(e){return"number"==e?c(this).length:"string"==e?h.toString.call(this):!!c(this).length}},d=Object.create(Array.prototype);t(c(h),function(e){d[e]=h[e]});var y=l(f(32,48)),g=l(f(32,48)),m=l(f(32,48)),b=l(f(32,48));function k(e,n,o,i=[]){n();var a=e.last("get").value;if(r(o)){o=[{to:"del",fn:o},{to:"set",fn:o}]}t(o,function(n){var t=n.to+":"+a;i.push(e.watch(t,n.fn)),n.fn(e.last(t))});var u=function(){t(i,function(e){e()}),i.length=0},c=function(){u(),k(e,n,o,i)};return i.push(e.watch("remap:"+a,c)),i.push(e.watch("del:"+a,c)),u}function w(n,r,o,i){var a=n.textContent,u=[];if(a.replace(/\{\:([\s\S]*?)\:\}(\|(\s|\n)*\{[\s\S]*?\}(\s|\n)*\|)?/g,function(e,n,t){u.push({drop:e,run:n,on:t&&t.replace(/^\|[\s\n]*\{|\}[\s\n]*\|$/g,"").split(/\}[\s\n]*\,[\s\n]*\{/g)})}),u.length){var c=[],s=function(){var r,i;n.textContent=(r=a,i=o,t(u,function(n){r=r.replace(n.drop,function(){try{return e.call(i,n.run)}catch(e){return console.error("failed to render expression ["+n.run+"]",i,e),""}})}),r)};return t(u,function(n){l(f(32,48));if(n.on){t(n.on,function(n){s.bind(null),s.bind(null);c.push(k(r,function(){e.call(o,"this."+i+("["===n[0]?"":".")+n)},s))})}else c.push(r.watch("asyncstart",s)),s()}),function(){t(c,function(e){e()})}}}var O=Object.create(Array.prototype);function A(e,n){t(e,function(e,t,r){n(e),A(e.childNodes,n)})}O.appendTo=function(e){if(o(e))return O.appendTo.call(this,document.querySelector(e));var n=e;return t(this,function(e){n.appendChild(e)}),this},O.detach=function(){return t(this,function(e){var n=e.parentElement;n&&n.removeChild(e)}),this};var x=l(f(32,48));function N(n,o,i,a){k(n,function(){var t=function(){return t};return t.in=function(e){if(!e||!r(e[b])||e[b]()!==n)throw new Error("Improper usage of key(string).in(array): in(array) is not provided with a proxified object of the same root");a.c=e},t.end=function(){},e.call(a.n,a.n.textContent,{key:t}),a.c.length},function(){var e,r,u,c=a.t,f=c.indexOf(a.u),s=c.indexOf(a.n),l=a.u.parentNode,v=(e=c.slice(s+1,f),r=a.key,u=[],t(e,function(e){var n=e[r];u[n]=u[n]||[],u[n].push(e)}),u),p=+a.c.length;if(v.length<p)for(;v.length!==p;){var h=a.i.map(function(e){return e.cloneNode(!0)});A(h,function(e){Object.defineProperty(e,a.key,{configurable:!0,enumerable:!1,get:function(e){return e}.bind(e,v.length)})}),j(h,o,n,i),l&&t(h,function(e){l.insertBefore(e,a.u)}),a.m&&t(h,function(e){e instanceof HTMLElement&&a.onClone(e)}),c.splice.apply(c,[f,0].concat(h)),f+=h.length,v.push(h)}else if(v.length>p)for(;v.length!==p;){var d=v.pop();t(d,function(e){c.splice(c.indexOf(e),1),e.parentNode&&e.parentNode.removeChild(e)}),A(d,function(e){e.dispatchEvent(new CustomEvent(x))})}})}function j(c,s,p,h){if(o(c)){var d=document.createElement("template");return d.innerHTML=c.trim(),j(d.content.childNodes,s,p,h)}if(c instanceof NodeList||c instanceof Array&&c.reduce(function(e,n){return e&&n instanceof Node},!0)){var y,g=n(c),m=function(e){if(y)throw new error("Improper usage of key(string).in(array): key(string) cannot be nested on the same level");return y={key:e},m};return m.in=function(e){if(!y)throw new Error("Improper usage of key(string).in(array): key(string) not called");if(y.c)throw new Error("Improper usage of key(string).in(array): in(array) called before key");y.i=[]},m.end=function(e){if(!(y&&y.key&&y.i&&y.i.length))throw new Error("Improper usage of key.end([onClone]): key(string).in(array) is not called properly prior to calling key.end([onClone])");y.t=g,y.u=y.i.pop(),r(e)&&(y.m=e);for(var n=y.i,t=g.length-1;t>=0;t--)if(-1!==n.indexOf(g[t])){var o=g[t].parentNode;o&&o.removeChild(g[t]),g.splice(t,1)}y.n=y.u.previousSibling,N(p,s,h,y),y=void 0},t(g,function(n){if(y&&y.i&&y.i.push(n),n instanceof Comment&&"foreach:"===n.textContent.trim().substr(0,8).toLowerCase()){if(j(n,s,p,h),e.call(n,n.textContent,{key:m}),!(!y||y.key&&y.i))throw new Error("Improper usage of key(string).in(array): in(array) not called in conjunction with key");y&&!y.n&&(y.n=n)}}),t(g,function(e){e[h]!==s&&j(e,s,p,h)}),Object.setPrototypeOf(g,O)}if(c instanceof Node){var b=c,A=[];if(Object.defineProperty(b,h,{configurable:!0,get:function(){return s},set:function(e){u(e)&&v(e,s)}}),A.push(function(){delete b[h]}),b instanceof CharacterData){var E=w(b,p,b,h);E&&A.push(E)}else j(b.childNodes,s,p,h);t(b.attributes,function(n){if(w(n,p,b,h),!("name"!==n.name||"INPUT"!==b.nodeName&"TEXTAREA"!==b.nodeName&"SELECT"!==b.nodeName)){var r=function(e){try{var n=e.value.toString();n!==b.value&&(b.value=n)}catch(e){b.value=null}},o="value",u=b.type.toLowerCase();"number"===u||"range"===u?(o="valueAsNumber",r=function(e){e&&a(e.value)?a(e.value)&&e.value!==b.valueAsNumber&&(b.valueAsNumber=e.value):b.value=null}):"checkbox"===u?(o="checked",r=function(e){!e||i(e.value)?b.checked=!1:i(e.value)&&e.value!==b.checked&&(b.checked=e.value)}):"radio"===u?r=function(e){try{var n=e.value.toString();e&&b.value===n&&!0!==b.checked?b.checked=!0:e&&b.value!==n&&!0===b.checked&&(b.checked=!1)}catch(e){b.checked=!1}}:"date"!==u&&"month"!==u&&"week"!==u&&"time"!==u&&"datetime-local"!==u||(o="valueAsDate",r=function(e){e&&e.value instanceof Date?e.value instanceof Date&&e.value.getTime()!==b.valueAsDate.getTime()&&(b.valueAsDate=e.value):b.value=null}),A.push(k(p,function(){e.call(b,"this."+h+("["===n.value[0]?"":".")+n.value)},[{to:"del",fn:r},{to:"set",fn:r}]));var c=["change","keyup","click"],s=function(t){var r=l(f(32,48));e.call(b,"this."+h+("["===n.value[0]?"":".")+n.value+" = "+r,{[r]:b[o]})};t(c,function(e){b.addEventListener(e,s)}),A.push(function(){t(c,function(e){b.removeEventListener(e,s)})})}});var C=function(e){e.stopPropagation(),t(A,function(e){e()})};return b.addEventListener(x,C),A.push(function(){b.removeEventListener(x,C)}),Object.setPrototypeOf([b],O)}}return function(e,n={},o="app"){var i,a,s=n[b];r(s)?(i=s(),a=n):(i=new function(){var e={},n={},o=(this.watch=function(t,o,i){var a,u;for(var c in r(o)?(a=t,u=o,i=i||{}):(a="**",u=t,i=o||{}),i)u.key=i.key;if(a.indexOf("*")>-1)var f=a.replace(/([!@#$%^&*(){}[\]\<\>:'"`\-_,./\\+-])/g,"\\$1").replace(/\\\*\\\*/g,".*").replace(/\\\*/,"[^:.]+"),s=(n[a]=n[a]||{regex:new RegExp(f),listeners:[]}).listeners;else s=e[a]=e[a]||[];return s.push(u),function(){s.splice(s.indexOf(u),1)}},{}),i=this.emit=function(r,i={}){for(var a=e[r]&&e[r].slice(),u=0;a&&u<a.length;u++)e[r].indexOf(a[u])>-1&&a[u](i,r);for(var c in n){var f=n[c];r.match(f.regex)&&t(f.listeners,function(e){e(i,r)})}return o[r]=i},a={},u=0,f=0,s=!1;this.async=function(e,n={}){s||(p(function(){var e=a;if(s=!1,a={},u=0,++f>3)f=0;else{var n=c(e);n.sort(function(n,t){return e[n].f>e[t].f?1:e[n].f<e[t].f?-1:0}),i("asyncstart",{payload:e,order:n}),t(n,function(n){i(n,e[n])}),i("asyncend",e),s||(f=0)}}),s=!0),a[e]=n,n.f=u+=1},this.last=function(e){return o[e]},this.next=function(e){return a[e]}},a=function e(n,o){var i,a=Object.getPrototypeOf(n);if(u(n)&&(a===Object.prototype&&(i=Object.create(h))||a===Array.prototype&&(i=Object.setPrototypeOf([],d)))){var s,p={[y]:function(e){return p[e]},[g]:k(g,"remap:"),[m]:k(m,"del:"),[b]:function(){return o}};function k(e,n){return function(){t(c(w),function(t){var i=w[t][e];r(i)&&i();var a={p:t};!o.next(n+p[t])&&o.async(n+p[t],a),Array.isArray(w)&&"length"===t&&(a.f=-1)})}}var w=new Proxy(i,s={get:function(e,n){if(n in e||n in p){if(!(n in e)&&n in p)return p[n]}else s.set(e,n,{});return p.hasOwnProperty(n)||(p[n]=l(f(32,48))),o.emit("get",{value:p[n]}),void 0===e[n]||null===e[n]?"":e[n]},set:function(n,t,i){try{var a=Object.getPrototypeOf(i)}catch(e){}var c=Array.isArray(n);if(c){var s=n.length;p.hasOwnProperty("length")||(p.length=l(f(32,48)))}var v=n[t]&&n[t][g];r(v)&&v(),i&&u(i)&&(a===Object.prototype||a===Array.prototype)?n[t]=e(i,o):n[t]=i,p.hasOwnProperty(t)||(p[t]=l(f(32,48)));var h={value:n[t],p:t};if(o.async("set:"+p[t],h),c&&"length"===t&&(h.f=-2),c&&s!==n.length){var d={value:n.length,p:t};o.async("set:"+p.length,d),d.f=-2}return Array.isArray(n[t])&&(n[t].length=n[t].length),!0},deleteProperty:function(e,n){if(n in e){var t=e[n][g];return r(t)&&t(),o.async("del:"+p[n],{value:e[n],p:n}),delete p[n],delete e[n],!0}return!1}});return v(n,w),w}}(n,i)),i.async("set:");var k=j(e,a,i,o);return Object.defineProperty(k,o,{get:function(){return a},set:function(e){u(e)&&v(e,a)}}),k}}(function(s,sv={}){for(var k in sv)s="var "+k+" = sv."+k+";\n"+s;return eval(s)});"undefined"!=typeof module&&(module.exports=proxymity);